<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستەمی بەڕێوەبردنی فرۆش</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {--primary-color: #007bff;--primary-hover: #0056b3;--danger-color: #dc3545;--warning-color: #ffc107;--success-color: #28a745;--text-color: #212529;--body-bg: #f8f9fa;--card-bg: #ffffff;--nav-bg: #343a40;--nav-text: #f8f9fa;--nav-hover-bg: #495057;--border-color: #dee2e6;--font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;--shadow: 0 4px 6px rgba(0, 0, 0, 0.05);--border-radius: 0.5rem;}
        body.dark-mode {--text-color: #f8f9fa;--body-bg: #121212;--card-bg: #1e1e1e;--nav-bg: #000000;--nav-hover-bg: #333333;--border-color: #444444;}
        body {font-family: var(--font-family); background-color: var(--body-bg); color: var(--text-color); margin: 0; padding: 0; font-weight: 500; transition: background-color 0.3s, color 0.3s;}
        .app-wrapper {display: flex;}
        nav {width: 220px; background-color: var(--nav-bg); color: var(--nav-text); height: 100vh; padding-top: 20px; display: flex; flex-direction: column; position: fixed; top: 0; border-left: 1px solid var(--border-color); transition: transform 0.3s ease-in-out; z-index: 100;}
        html[dir="rtl"] nav {right: 0; transform: translateX(0);}
        html[dir="ltr"] nav {left: 0; transform: translateX(0);}
        nav .logo {text-align: center; font-size: 24px; font-weight: bold; padding: 0 20px 20px 20px; color: var(--primary-color);}
        nav button {background-color: transparent; color: var(--nav-text); border: none; padding: 15px 20px; cursor: pointer; font-size: 16px; transition: all 0.3s; text-align: right; border-right: 4px solid transparent; font-family: inherit;}
        html[dir="ltr"] nav button {text-align: left; border-right: none; border-left: 4px solid transparent;}
        nav button.active, nav button:hover {background-color: var(--nav-hover-bg);}
        html[dir="rtl"] nav button.active, html[dir="rtl"] nav button:hover {border-right-color: var(--primary-color);}
        html[dir="ltr"] nav button.active, html[dir="ltr"] nav button:hover {border-left-color: var(--primary-color);}
        .theme-switcher-container {margin-top: auto; position: relative;}
        #theme-menu {display: none; position: absolute; bottom: 100%; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow); width: 150px; z-index: 101;}
        html[dir="rtl"] #theme-menu {right: 10px;}
        html[dir="ltr"] #theme-menu {left: 10px;}
        #theme-menu button {width: 100%; color: var(--text-color); border:none !important;}
        #theme-menu button:hover {background-color: var(--nav-hover-bg);}
        .content-area {flex-grow: 1; min-height: 100vh;}
        html[dir="rtl"] .content-area {margin-right: 220px;}
        html[dir="ltr"] .content-area {margin-left: 220px;}
        .page {display: none; padding: 20px;}
        .page.active {display: block;}
        .container {background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        h1, h2 {color: var(--text-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; margin-top: 0; font-weight: 600;}
        input, select, button, datalist {width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 16px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-sizing: border-box; font-size: 16px; background-color: var(--body-bg); color: var(--text-color); font-family: inherit;}
        button {background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s;}
        button:hover {opacity: 0.9;}
        table {width: 100%; border-collapse: collapse; margin-top: 20px; display: block; overflow-x: auto;}
        th, td {text-align: right; padding: 15px; border-bottom: 1px solid var(--border-color); white-space: nowrap;}
        html[dir="ltr"] th, html[dir="ltr"] td {text-align: left;}
        th {background-color: rgba(0,0,0,0.05); font-weight: 600;}
        .dashboard-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;}
        .metric p {font-size: 22px; font-weight: 700;}
        .metric.net-profit p {color: var(--success-color);}
        .action-btn {padding: 5px 10px; font-size: 12px; width: auto; margin: 0 5px; color: white !important;}
        .edit-btn {background-color: var(--warning-color); border:none;}
        .delete-btn {background-color: var(--danger-color); border: none;}
        .report-content {display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;}
        .report-table-container {flex: 3; min-width: 300px;}
        .chart-container {position: relative; height: 350px; width: 100%;}
        .report-chart-container {flex: 2; min-width: 300px;}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.7)}.modal-content{background-color:var(--card-bg);margin:10% auto;padding:25px;border:1px solid var(--border-color);width:90%;max-width:500px;border-radius:var(--border-radius)}
        .close-btn{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer}
        html[dir="rtl"] .close-btn {float:left;} html[dir="ltr"] .close-btn {float:right;}
        #backup-alert, .warning-text {color: var(--warning-color); font-weight: bold; margin-top: 10px;}
        #backup-alert {display: none; padding: 15px; background-color: var(--warning-color); color: #fff; text-align: center; border-radius: var(--border-radius); margin: 20px;}
        #menu-toggle {display: none; position: fixed; top: 15px; z-index: 101; background: var(--nav-bg); color: white; border: 1px solid white; border-radius: 5px; width: 40px; height: 40px; font-size: 24px; padding: 0;}
        html[dir="rtl"] #menu-toggle {right: 15px;}
        html[dir="ltr"] #menu-toggle {left: 15px;}
        .overlay {display: none; position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99;}
        @media (max-width: 768px) {
            #menu-toggle {display: block;}
            .content-area {margin: 0 !important;}
            html[dir="rtl"] nav {transform: translateX(100%);}
            html[dir="ltr"] nav {transform: translateX(-100%);}
            nav.open {transform: translateX(0);}
            .overlay.open {display: block;}
            .page {padding: 15px;}
            .metric p {font-size: 20px;}
        }
    </style>
</head>
<body>
    <div id="overlay" class="overlay"></div>
    <button id="menu-toggle">&#9776;</button>

    <!-- Modals -->
    <div id="editSaleModal" class="modal"> <div class="modal-content"> <span class="close-btn">&times;</span> <h2 data-lang-key="edit_sale"></h2> <form id="editSaleForm"> <input type="hidden" id="editSaleId"><label data-lang-key="product_name"></label><input type="text" id="editSaleProductName" required><label data-lang-key="category"></label><input type="text" id="editSaleCategory" required><label data-lang-key="cost_price_usd"></label><input type="number" id="editSaleCostPrice" min="0" step="0.01" required><label data-lang-key="selling_price_usd"></label><input type="number" id="editSaleSellingPrice" min="0" step="0.01" required><label data-lang-key="quantity_sold"></label><input type="number" id="editSaleQuantity" min="1" required><label data-lang-key="sale_date"></label><input type="date" id="editSaleDate" required><button type="submit" data-lang-key="save"></button> </form> </div> </div>

    <div class="app-wrapper">
        <main class="content-area">
            <div id="backup-alert"><span data-lang-key="backup_alert_text"></span> <a href="#" onclick="document.querySelector('[data-page=settingsPage]').click();" style="color:white; text-decoration: underline;" data-lang-key="backup_now"></a></div>
            <!-- Pages -->
            <div id="dashboardPage" class="page active"><div class="container"><h1 data-lang-key="dashboard"></h1><div class="dashboard-grid"><div class="metric"><h3 data-lang-key="total_revenue"></h3><p id="totalRevenue"></p></div><div class="metric"><h3 data-lang-key="total_profit"></h3><p id="totalProfit"></p></div><div class="metric"><h3 data-lang-key="total_expenses"></h3><p id="totalExpenses"></p></div><div class="metric net-profit"><h3 data-lang-key="net_profit"></h3><p id="netProfit"></p></div></div></div><div class="container"><h2 data-lang-key="category_sales_30_days"></h2><div class="chart-container"><canvas id="dashboardChart"></canvas></div></div></div>
            <div id="addSalePage" class="page"><div class="container"><h1 data-lang-key="log_new_sale"></h1><form id="addSaleForm"><label data-lang-key="product_name"></label><input type="text" id="saleProductName" list="productList" required><datalist id="productList"></datalist><label data-lang-key="category"></label><input type="text" id="saleCategory" required><label data-lang-key="cost_price_usd"></label><input type="number" id="saleCostPrice" min="0" step="0.01" required><label data-lang-key="selling_price_usd"></label><input type="number" id="saleSellingPrice" min="0" step="0.01" required><label data-lang-key="quantity_sold"></label><input type="number" id="saleQuantity" value="1" min="1" required><label data-lang-key="sale_date"></label><input type="date" id="newSaleDate" required><button type="submit" data-lang-key="log_sale"></button></form></div></div>
            <div id="salesHistoryPage" class="page"><div class="container"><h2 data-lang-key="sales_history"></h2><table id="salesTable"><thead></thead><tbody></tbody></table></div></div>
            <div id="expensesPage" class="page"><div class="container"><h2 data-lang-key="add_new_expense"></h2><form id="addExpenseForm"><label data-lang-key="expense_desc"></label><input type="text" id="expenseDescription" required><label data-lang-key="expense_amount_usd"></label><input type="number" id="expenseAmount" min="0" step="0.01" required><label data-lang-key="expense_date"></label><input type="date" id="expenseDate" required><button type="submit" data-lang-key="add_expense"></button></form></div><div class="container"><h2 data-lang-key="expenses_list"></h2><table id="expensesTable"><thead></thead><tbody></tbody></table></div></div>
            <div id="reportsPage" class="page"><div class="container"><h1 data-lang-key="reports"></h1><div class="report-filters"><div class="form-group"><label data-lang-key="report_period"></label><select id="reportPeriod"></select></div><div class="form-group custom-date-filters" style="display: none;"><label data-lang-key="start_date"></label><input type="date" id="startDate"></div><div class="form-group custom-date-filters" style="display: none;"><label data-lang-key="end_date"></label><input type="date" id="endDate"></div><div class="form-group"><label data-lang-key="report_type"></label><select id="reportType"></select></div><button id="generateReportBtn" style="width: auto;" data-lang-key="generate_report"></button></div></div><div id="reportResult" class="container" style="display: none;"><h2 data-lang-key="report_results"></h2><div class="dashboard-grid"><div class="metric"><h3 data-lang-key="total_revenue"></h3><p id="reportRevenue"></p></div><div class="metric"><h3 data-lang-key="total_profit"></h3><p id="reportProfit"></p></div><div class="metric"><h3 data-lang-key="total_expenses"></h3><p id="reportExpenses"></p></div><div class="metric net-profit"><h3 data-lang-key="net_profit"></h3><p id="reportNetProfit"></p></div></div><div class="report-content"><div class="report-table-container"><h3 data-lang-key="report_details"></h3><table id="reportDetailTable"><thead></thead><tbody></tbody></table></div><div class="report-chart-container"><h3 data-lang-key="visual_summary"></h3><div class="chart-container"><canvas id="reportChart"></canvas></div></div></div></div></div>
            <div id="settingsPage" class="page"><div class="container"><h2 data-lang-key="backup_restore"></h2><p data-lang-key="backup_desc"></p><button id="backupBtn" data-lang-key="download_backup"></button><hr style="margin: 20px 0;"><h2 data-lang-key="restore_data"></h2><p class="warning-text" data-lang-key="restore_warning"></p><button id="restoreBtn" style="background-color: var(--danger-color);" data-lang-key="upload_backup"></button><input type="file" id="restoreInput" accept=".json" style="display: none;"></div><div class="container"><h2 data-lang-key="language"></h2><select id="languageSelector"></select></div></div>
        </main>
        
        <nav id="navMenu">
            <div class="logo">سیستەمی فرۆش</div>
            <button class="nav-btn active" data-page="dashboardPage" data-lang-key="dashboard"></button>
            <button class="nav-btn" data-page="addSalePage" data-lang-key="new_sale"></button>
            <button class="nav-btn" data-page="salesHistoryPage" data-lang-key="sales_history"></button>
            <button class="nav-btn" data-page="expensesPage" data-lang-key="expenses"></button>
            <button class="nav-btn" data-page="reportsPage" data-lang-key="reports"></button>
            <button class="nav-btn" data-page="settingsPage" data-lang-key="settings"></button>
            <div class="theme-switcher-container"><button id="theme-switcher-btn"></button><div id="theme-menu"></div></div>
        </nav>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const translations={ku:{dashboard:"داشبۆرد",new_sale:"فرۆشی نوێ",sales_history:"مێژووی فرۆشتن",expenses:"تێچووەکان",reports:"ڕاپۆرتەکان",settings:"ڕێکخستنەکان",theme:"دۆخ",light:"ڕووناک",dark:"تاریک",system:"سیستەم",total_revenue:"کۆی فرۆش",total_profit:"کۆی قازانج",total_expenses:"کۆی تێچووەکان",net_profit:"قازانجی سافی",category_sales_30_days:"فرۆشی هاوپۆلەکان (کۆتا ٣٠ ڕۆژ)",log_new_sale:"تۆمارکردنی فرۆشی نوێ",product_name:"ناوی کاڵا",category:"هاوپۆڵ",cost_price_usd:"تێچوو ($)",selling_price_usd:"نرخی فرۆشتن ($)",quantity_sold:"ژمارەی فرۆشراو",log_sale:"تۆمارکردن",sale_logged_success:"فرۆشەکە بە سەرکەوتوویی تۆمارکرا!",product:"کاڵا",actions:"کردارەکان",sale_date:"بەرواری فرۆشتن",gross_profit:"قازانج",edit:"دەستکاری",delete:"سڕینەوە",save:"پاشەکەوتکردن",edit_sale:"دەستکاریکردنی فرۆش",add_new_expense:"زیادکردنی تێچووی نوێ",expense_desc:"باسی تێچوو",expense_amount_usd:"بڕی تێچوو ($)",expense_date:"بەرواری تێچوو",add_expense:"زیادکردنی تێچوو",expenses_list:"لیستی تێچووەکان",expense_added_success:"تێچووەکە تۆمارکرا!",report_period:"ماوەی ڕاپۆرت",report_type:"جۆری ڕاپۆرت",generate_report:"دروستکردنی ڕاپۆرت",report_results:"ئەنجامی ڕاپۆرت",report_details:"ورردەکاری ڕاپۆرت",visual_summary:"پوختەی بینراو",last30days:"٣٠ ڕۆژی ڕابردوو",last6months:"٦ مانگی ڕابردوو",thisYear:"ئەمساڵ",custom:"دیاریکردنی ماوە",by_category:"بە گوێرەی هاوپۆل",by_product:"بە گوێرەی کاڵا",start_date:"بەرواری دەستپێک",end_date:"بەرواری کۆتایی",backup_restore:"بەکئەپ و گەڕاندنەوە",backup_desc:"بۆ پاراستنی داتاکانت، دەتوانیت بە شێوەیەکی بەردەوام فایلی بەکئەپ دابگریت.",download_backup:"داگرتنی فایلی بەکئەپ",restore_data:"گەڕاندنەوەی داتا",restore_warning:"ئاگاداری: گەڕاندنەوەی داتا هەموو داتا ئێستاکان دەسڕێتەوە. دڵنیایت؟",upload_backup:"بارکردنی فایلی بەکئەپ",language:"زمان",backup_alert_text:"ئاگاداری: ماوەی هەفتەیەکە بەکئەپت نەکردووە.",backup_now:"ئێستا بیکە!",confirm_delete_sale:"دڵنیایت لە سڕینەوەی ئەم فرۆشە؟",confirm_delete_expense:"دڵنیایت لە سڕینەوەی ئەم تێچووە؟",data_restored_success:"داتاکان بە سەرکەوتوویی گەڕێنرانەوە!",invalid_file:"فایلی هەڵە!",error_reading_file:"هەڵەیەک لە خوێندنەوەی فایلەکە ڕوویدا!",uncategorized:"بێ هاوپۆل"},en:{dashboard:"Dashboard",new_sale:"New Sale",sales_history:"Sales History",expenses:"Expenses",reports:"Reports",settings:"Settings",theme:"Theme",light:"Light",dark:"Dark",system:"System",total_revenue:"Total Revenue",total_profit:"Gross Profit",total_expenses:"Total Expenses",net_profit:"Net Profit",category_sales_30_days:"Category Sales (Last 30 Days)",log_new_sale:"Log New Sale",product_name:"Product Name",category:"Category",cost_price_usd:"Cost Price ($)",selling_price_usd:"Selling Price ($)",quantity_sold:"Quantity Sold",log_sale:"Log Sale",sale_logged_success:"Sale logged successfully!",product:"Product",actions:"Actions",sale_date:"Sale Date",gross_profit:"Profit",edit:"Edit",delete:"Delete",save:"Save",edit_sale:"Edit Sale",add_new_expense:"Add New Expense",expense_desc:"Expense Description",expense_amount_usd:"Amount ($)",expense_date:"Expense Date",add_expense:"Add Expense",expenses_list:"Expenses List",expense_added_success:"Expense added!",report_period:"Report Period",report_type:"Report Type",generate_report:"Generate Report",report_results:"Report Results",report_details:"Report Details",visual_summary:"Visual Summary",last30days:"Last 30 Days",last6months:"Last 6 Months",thisYear:"This Year",custom:"Custom Range",by_category:"By Category",by_product:"By Product",start_date:"Start Date",end_date:"End Date",backup_restore:"Backup & Restore",backup_desc:"To protect your data, you can regularly download a backup file.",download_backup:"Download Backup File",restore_data:"Restore Data",restore_warning:"Warning: Restoring will overwrite all current data. Are you sure?",upload_backup:"Upload Backup File",language:"Language",backup_alert_text:"Warning: You haven't backed up in over a week.",backup_now:"Backup now!",confirm_delete_sale:"Are you sure you want to delete this sale?",confirm_delete_expense:"Are you sure you want to delete this expense?",data_restored_success:"Data restored successfully!",invalid_file:"Invalid file!",error_reading_file:"Error reading file!",uncategorized:"Uncategorized"},ar:{dashboard:"لوحة التحكم",new_sale:"بيع جديد",sales_history:"سجل المبيعات",expenses:"المصاريف",reports:"التقارير",settings:"الإعدادات",theme:"الوضع",light:"فاتح",dark:"داكن",system:"النظام",total_revenue:"إجمالي الإيرادات",total_profit:"إجمالي الربح",total_expenses:"إجمالي المصاريف",net_profit:"صافي الربح",category_sales_30_days:"مبيعات الفئات (آخر 30 يومًا)",log_new_sale:"تسجيل بيع جديد",product_name:"اسم المنتج",category:"الفئة",cost_price_usd:"سعر التكلفة ($)",selling_price_usd:"سعر البيع ($)",quantity_sold:"الكمية",log_sale:"تسجيل",sale_logged_success:"تم تسجيل البيع بنجاح!",product:"المنتج",actions:"الإجراءات",sale_date:"تاريخ البيع",gross_profit:"الربح",edit:"تعديل",delete:"حذف",save:"حفظ",edit_sale:"تعديل البيع",add_new_expense:"إضافة مصروف",expense_desc:"الوصف",expense_amount_usd:"المبلغ ($)",expense_date:"التاريخ",add_expense:"إضافة",expenses_list:"قائمة المصاريف",expense_added_success:"تمت إضافة المصروف!",report_period:"فترة التقرير",report_type:"نوع التقرير",generate_report:"إنشاء تقرير",report_results:"نتائج التقرير",report_details:"التفاصيل",visual_summary:"ملخص مرئي",last30days:"آخر 30 يومًا",last6months:"آخر 6 أشهر",thisYear:"هذه السنة",custom:"فترة مخصصة",by_category:"حسب الفئة",by_product:"حسب المنتج",start_date:"تاريخ البدء",end_date:"تاريخ الانتهاء",backup_restore:"النسخ الاحتياطي والاستعادة",backup_desc:"لحماية بياناتك، قم بتنزيل نسخة احتياطية بانتظام.",download_backup:"تنزيل نسخة",restore_data:"استعادة البيانات",restore_warning:"تحذير: الاستعادة ستحذف كل البيانات الحالية. هل أنت متأكد؟",upload_backup:"تحميل نسخة",language:"اللغة",backup_alert_text:"تحذير: لم تقم بعمل نسخة احتياطية منذ أكثر من أسبوع.",backup_now:"انسخ الآن!",confirm_delete_sale:"هل أنت متأكد من حذف هذا البيع؟",confirm_delete_expense:"هل أنت متأكد من حذف هذا المصروف؟",data_restored_success:"تم استعادة البيانات بنجاح!",invalid_file:"ملف غير صالح!",error_reading_file:"خطأ في قراءة الملف!",uncategorized:"بدون فئة"}};
    
    // --- Elements ---
    const navButtons=document.querySelectorAll('.nav-btn');const pages=document.querySelectorAll('.page');const salesTable=document.getElementById('salesTable');const expensesTable=document.getElementById('expensesTable');const addSaleForm=document.getElementById('addSaleForm');const editSaleModal=document.getElementById('editSaleModal'),closeBtns=document.querySelectorAll('.close-btn');const totalProfitEl=document.getElementById('totalProfit'),totalRevenueEl=document.getElementById('totalRevenue'),totalExpensesEl=document.getElementById('totalExpenses'),netProfitEl=document.getElementById('netProfit');const reportPeriodSelect=document.getElementById('reportPeriod'),customDateFilters=document.querySelectorAll('.custom-date-filters'),startDateInput=document.getElementById('startDate'),endDateInput=document.getElementById('endDate'),generateReportBtn=document.getElementById('generateReportBtn'),reportResultContainer=document.getElementById('reportResult'),reportTypeSelect=document.getElementById('reportType');const themeSwitcherBtn=document.getElementById('theme-switcher-btn'),themeMenu=document.getElementById('theme-menu');const addExpenseForm=document.getElementById('addExpenseForm');const backupBtn=document.getElementById('backupBtn'),restoreBtn=document.getElementById('restoreBtn'),restoreInput=document.getElementById('restoreInput');const languageSelector=document.getElementById('languageSelector');let dashboardChart=null,reportChart=null;
    const menuToggle=document.getElementById('menu-toggle');const navMenu=document.getElementById('navMenu');const overlay=document.getElementById('overlay');
    let sales=JSON.parse(localStorage.getItem('sales'))||[];let expenses=JSON.parse(localStorage.getItem('expenses'))||[];let lastBackupDate=localStorage.getItem('lastBackupDate');let currentLang=localStorage.getItem('language')||'ku';
    function saveData(){localStorage.setItem('sales',JSON.stringify(sales));localStorage.setItem('expenses',JSON.stringify(expenses));}
    
    function applyTranslations(lang) {
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'ku' || lang === 'ar') ? 'rtl' : 'ltr';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (translations[lang] && translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        reportPeriodSelect.innerHTML = `<option value="last30days">${translations[lang].last30days}</option><option value="last6months">${translations[lang].last6months}</option><option value="thisYear">${translations[lang].thisYear}</option><option value="custom">${translations[lang].custom}</option>`;
        reportTypeSelect.innerHTML = `<option value="category">${translations[lang].by_category}</option><option value="product">${translations[lang].by_product}</option>`;
        themeMenu.innerHTML = `<button data-theme="light">${translations[lang].light}</button><button data-theme="dark">${translations[lang].dark}</button><button data-theme="system">${translations[lang].system}</button>`;
        
        const themeTextKey = {light:'light', dark:'dark', system:'system'};
        themeSwitcherBtn.textContent = `${translations[lang].theme}: ${translations[lang][themeTextKey[currentTheme]]}`;
    }

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('language', lang);
        applyTranslations(lang);
        renderSales();
        renderExpenses();
    }
    
    let currentTheme=localStorage.getItem('theme')||'system';
    function applyTheme(theme) {
        document.body.classList.remove('dark-mode');
        if (theme === 'system') {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemPrefersDark) document.body.classList.add('dark-mode');
        } else if (theme === 'dark') {
            document.body.classList.add('dark-mode');
        }
        localStorage.setItem('theme', theme);
        applyTranslations(currentLang);
        if (document.getElementById('dashboardPage').classList.contains('active')) renderDashboardChart();
        if (reportResultContainer.style.display === 'block') generateReportBtn.click();
    }

    themeSwitcherBtn.addEventListener('click', e => { e.stopPropagation(); themeMenu.style.display = themeMenu.style.display === 'block' ? 'none' : 'block'; });
    themeMenu.addEventListener('click', e => { if(e.target.matches('button')) { currentTheme = e.target.dataset.theme; applyTheme(currentTheme); themeMenu.style.display = 'none'; } });
    window.addEventListener('click', () => { themeMenu.style.display = 'none'; });
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (currentTheme === 'system') applyTheme('system'); });

    function showPage(pageId) { pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); navButtons.forEach(b => b.classList.remove('active')); document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active'); if(pageId === 'dashboardPage') renderDashboardChart(); navMenu.classList.remove('open'); overlay.classList.remove('open'); }
    navButtons.forEach(b => b.addEventListener('click', () => showPage(b.dataset.page)));
    menuToggle.addEventListener('click', () => { navMenu.classList.toggle('open'); overlay.classList.toggle('open'); });
    overlay.addEventListener('click', () => { navMenu.classList.remove('open'); overlay.classList.remove('open'); });

    function renderSales() {
        salesTable.innerHTML = `<thead><tr><th data-lang-key="product_name">${translations[currentLang].product_name}</th><th data-lang-key="category">${translations[currentLang].category}</th><th data-lang-key="quantity_sold">${translations[currentLang].quantity_sold}</th><th data-lang-key="total_revenue">${translations[currentLang].total_revenue}</th><th data-lang-key="gross_profit">${translations[currentLang].gross_profit}</th><th data-lang-key="sale_date">${translations[currentLang].sale_date}</th><th data-lang-key="actions">${translations[currentLang].actions}</th></tr></thead><tbody></tbody>`;
        const tbody = salesTable.querySelector('tbody');
        sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
            const row = tbody.insertRow();
            const totalRevenue = s.sellingPrice * s.quantity;
            const totalProfit = s.profit * s.quantity;
            row.innerHTML = `<td>${s.productName}</td><td>${s.category}</td><td>${s.quantity}</td><td>${formatCurrency(totalRevenue)}</td><td style="color:${totalProfit > 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${formatCurrency(totalProfit)}</td><td>${new Date(s.date).toLocaleDateString(currentLang === 'en' ? 'en-US' : 'ar-IQ')}</td> <td><button class="action-btn edit-btn" data-sale-id="${s.id}">${translations[currentLang].edit}</button><button class="action-btn delete-btn" data-sale-id="${s.id}">${translations[currentLang].delete}</button></td>`;
        });
    }

    function renderExpenses() {
        expensesTable.innerHTML = `<thead><tr><th data-lang-key="expense_desc">${translations[currentLang].expense_desc}</th><th data-lang-key="expense_amount_usd">${translations[currentLang].expense_amount_usd}</th><th data-lang-key="expense_date">${translations[currentLang].expense_date}</th><th data-lang-key="actions">${translations[currentLang].actions}</th></tr></thead><tbody></tbody>`;
        const tbody = expensesTable.querySelector('tbody');
        expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${ex.description}</td><td>${formatCurrency(ex.amount)}</td><td>${new Date(ex.date).toLocaleDateString(currentLang === 'en' ? 'en-US' : 'ar-IQ')}</td><td><button class="action-btn delete-btn" data-expense-id="${ex.id}">${translations[currentLang].delete}</button></td>`;
        });
    }
    
    function updateDashboard() { const totalRevenue = sales.reduce((sum, s) => sum + (s.sellingPrice * s.quantity), 0); const totalGrossProfit = sales.reduce((sum, s) => sum + (s.profit * s.quantity), 0); const totalAllExpenses = expenses.reduce((sum, ex) => sum + ex.amount, 0); totalRevenueEl.textContent = formatCurrency(totalRevenue); totalProfitEl.textContent = formatCurrency(totalGrossProfit); totalExpensesEl.textContent = formatCurrency(totalAllExpenses); netProfitEl.textContent = formatCurrency(totalGrossProfit - totalAllExpenses); }
    
    function populateProductList() { const productList = document.getElementById('productList'); const uniqueProducts = [...new Map(sales.map(s => [s.productName.toLowerCase(), s])).values()]; productList.innerHTML = ''; uniqueProducts.forEach(s => { const option = document.createElement('option'); option.value = s.productName; productList.appendChild(option); }); }
    function formatCurrency(amount) { return `$${parseFloat(amount).toFixed(2)}`; }
    function renderPieChart(canvasId, chartInstance, data, labelKey) { const ctx = document.getElementById(canvasId).getContext('2d'); if (chartInstance) chartInstance.destroy(); const labels = data.map(item => item[labelKey]); const revenues = data.map(item => item.revenue); const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#20c997', '#6f42c1']; const style = getComputedStyle(document.body); const textColor = style.getPropertyValue('--text-color'); return new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: revenues, backgroundColor: colors, borderColor: style.getPropertyValue('--card-bg'), borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, font: { family: style.getPropertyValue('--font-family') } } }, tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.raw)}` } } } } }); }
    function renderDashboardChart() { const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const recentSales = sales.filter(s => new Date(s.date) >= thirtyDaysAgo); const categorySales = {}; recentSales.forEach(s => { const cat = s.category || translations[currentLang].uncategorized; if (!categorySales[cat]) categorySales[cat] = { revenue: 0 }; categorySales[cat].revenue += s.sellingPrice * s.quantity; }); const chartData = Object.keys(categorySales).map(cat => ({ category: cat, revenue: categorySales[cat].revenue })).sort((a,b) => b.revenue - a.revenue); dashboardChart = renderPieChart('dashboardChart', dashboardChart, chartData, 'category'); }

    function checkBackupStatus() { const alertBox = document.getElementById('backup-alert'); if (lastBackupDate) { const daysSinceBackup = (new Date() - new Date(lastBackupDate)) / (1000 * 60 * 60 * 24); if (daysSinceBackup > 7) { alertBox.style.display = 'block'; } else { alertBox.style.display = 'none'; } } else if (sales.length > 0) { alertBox.style.display = 'block'; } }

    function refreshAll() { populateProductList(); renderSales(); renderExpenses(); updateDashboard(); if (document.getElementById('dashboardPage').classList.contains('active')) renderDashboardChart(); checkBackupStatus(); }
    document.getElementById('saleProductName').addEventListener('input', e => { const product = [...new Map(sales.map(s => [s.productName.toLowerCase(), s])).values()].find(s => s.productName.toLowerCase() === e.target.value.toLowerCase()); if (product) { document.getElementById('saleCategory').value = product.category; document.getElementById('saleCostPrice').value = product.costPrice; document.getElementById('saleSellingPrice').value = product.sellingPrice; } });
    addSaleForm.addEventListener('submit', e => { e.preventDefault(); const cost = parseFloat(document.getElementById('saleCostPrice').value); const selling = parseFloat(document.getElementById('saleSellingPrice').value); sales.unshift({ id: Date.now(), productName: document.getElementById('saleProductName').value, category: document.getElementById('saleCategory').value.trim(), costPrice: cost, sellingPrice: selling, quantity: parseInt(document.getElementById('saleQuantity').value), profit: selling - cost, date: new Date(document.getElementById('newSaleDate').value || new Date()).toISOString() }); saveData(); refreshAll(); addSaleForm.reset(); document.getElementById('newSaleDate').valueAsDate = new Date(); alert(translations[currentLang].sale_logged_success); });
    addExpenseForm.addEventListener('submit', e => { e.preventDefault(); expenses.unshift({ id: Date.now(), description: document.getElementById('expenseDescription').value, amount: parseFloat(document.getElementById('expenseAmount').value), date: new Date(document.getElementById('expenseDate').value || new Date()).toISOString() }); saveData(); refreshAll(); addExpenseForm.reset(); document.getElementById('expenseDate').valueAsDate = new Date(); alert(translations[currentLang].expense_added_success); });
    
    expensesTable.addEventListener('click', e => { if (e.target.matches('.delete-btn')) { const expenseId = parseInt(e.target.dataset.expenseId); if (confirm(translations[currentLang].confirm_delete_expense)) { expenses = expenses.filter(ex => ex.id !== expenseId); saveData(); refreshAll(); } } });
    salesTable.addEventListener('click', e => { if (e.target.matches('.delete-btn')) { const saleId = parseInt(e.target.dataset.saleId); if (confirm(translations[currentLang].confirm_delete_sale)) { sales = sales.filter(s => s.id !== saleId); saveData(); refreshAll(); } } if (e.target.matches('.edit-btn')) { const sale = sales.find(s => s.id === parseInt(e.target.dataset.saleId)); if (sale) { document.getElementById('editSaleId').value = sale.id; document.getElementById('editSaleProductName').value = sale.productName; document.getElementById('editSaleCategory').value = sale.category; document.getElementById('editSaleCostPrice').value = sale.costPrice; document.getElementById('editSaleSellingPrice').value = sale.sellingPrice; document.getElementById('editSaleQuantity').value = sale.quantity; document.getElementById('editSaleDate').value = sale.date.split('T')[0]; editSaleModal.style.display = 'block'; } } });
    
    document.getElementById('editSaleForm').addEventListener('submit', e => { e.preventDefault(); const saleId = parseInt(document.getElementById('editSaleId').value); const sale = sales.find(s => s.id === saleId); if (sale) { const cost = parseFloat(document.getElementById('editSaleCostPrice').value); const selling = parseFloat(document.getElementById('editSaleSellingPrice').value); sale.productName = document.getElementById('editSaleProductName').value; sale.category = document.getElementById('editSaleCategory').value.trim(); sale.costPrice = cost; sale.sellingPrice = selling; sale.quantity = parseInt(document.getElementById('editSaleQuantity').value); sale.date = new Date(document.getElementById('editSaleDate').value).toISOString(); sale.profit = selling - cost; saveData(); refreshAll(); editSaleModal.style.display = 'none'; } });
    closeBtns.forEach(b => b.onclick = () => b.closest('.modal').style.display = 'none');
    
    reportPeriodSelect.addEventListener('change', () => { customDateFilters.forEach(el => el.style.display = reportPeriodSelect.value === 'custom' ? 'block' : 'none'); });
    generateReportBtn.addEventListener('click', () => {
        let startDate, endDate = new Date();
        switch(reportPeriodSelect.value) { case 'last30days': startDate = new Date(); startDate.setDate(endDate.getDate() - 30); break; case 'last6months': startDate = new Date(); startDate.setMonth(endDate.getMonth() - 6); break; case 'thisYear': startDate = new Date(endDate.getFullYear(), 0, 1); break; case 'custom': startDate = new Date(startDateInput.value || "1970-01-01"); endDate = new Date(endDateInput.value || new Date()); endDate.setHours(23, 59, 59); break; }
        const filteredSales = sales.filter(s => { const d = new Date(s.date); return d >= startDate && d <= endDate; });
        const filteredExpenses = expenses.filter(ex => { const d = new Date(ex.date); return d >= startDate && d <= endDate; });
        const reportRevenue = filteredSales.reduce((s,c)=>s+(c.sellingPrice*c.quantity),0); const reportGrossProfit = filteredSales.reduce((s,c)=>s+(c.profit*c.quantity),0); const reportTotalExpenses = filteredExpenses.reduce((s,c)=>s+c.amount,0);
        document.getElementById('reportRevenue').textContent = formatCurrency(reportRevenue); document.getElementById('reportProfit').textContent = formatCurrency(reportGrossProfit); document.getElementById('reportExpenses').textContent = formatCurrency(reportTotalExpenses); document.getElementById('reportNetProfit').textContent = formatCurrency(reportGrossProfit - reportTotalExpenses);
        const aggregation = {}; const reportType = reportTypeSelect.value;
        filteredSales.forEach(s => { const key = reportType === 'category' ? (s.category || translations[currentLang].uncategorized) : s.productName; if (!aggregation[key]) aggregation[key] = { name: key, revenue: 0, profit: 0, count: 0 }; aggregation[key].revenue += s.sellingPrice * s.quantity; aggregation[key].profit += s.profit * s.quantity; aggregation[key].count += s.quantity; });
        const reportDetailTable = document.getElementById('reportDetailTable'), tbody = reportDetailTable.querySelector('tbody'); tbody.innerHTML = '';
        reportDetailTable.querySelector('thead').innerHTML = `<tr><th data-lang-key="${reportType==='category' ? 'category':'product_name'}"></th><th data-lang-key="total_revenue"></th><th data-lang-key="gross_profit"></th><th data-lang-key="quantity_sold"></th></tr>`;
        const sortedAggregation = Object.values(aggregation).sort((a,b) => b.revenue - a.revenue);
        sortedAggregation.forEach(item => { const row = tbody.insertRow(); row.innerHTML = `<td>${item.name}</td><td>${formatCurrency(item.revenue)}</td><td>${formatCurrency(item.profit)}</td><td>${item.count}</td>`; });
        reportResultContainer.style.display = 'block'; reportChart = renderPieChart('reportChart', reportChart, sortedAggregation, 'name'); applyTranslations(currentLang);
    });

    backupBtn.addEventListener('click', () => { const dataToBackup = { sales: sales, expenses: expenses }; const dataStr = JSON.stringify(dataToBackup, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = `backup-${new Date().toISOString().split('T')[0]}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); lastBackupDate = new Date().toISOString(); localStorage.setItem('lastBackupDate', lastBackupDate); checkBackupStatus(); });
    restoreBtn.addEventListener('click', () => restoreInput.click());
    restoreInput.addEventListener('change', e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = event => { try { const restoredData = JSON.parse(event.target.result); if (Array.isArray(restoredData.sales) && Array.isArray(restoredData.expenses)) { if (confirm(translations[currentLang].restore_warning)) { sales = restoredData.sales; expenses = restoredData.expenses; saveData(); refreshAll(); alert(translations[currentLang].data_restored_success); } } else { alert(translations[currentLang].invalid_file); } } catch (error) { alert(translations[currentLang].error_reading_file); } finally { restoreInput.value = ''; } }; reader.readAsText(file); });

    // --- Initial Load ---
    languageSelector.innerHTML = `<option value="ku">کوردی</option><option value="en">English</option><option value="ar">العربية</option>`;
    languageSelector.value = currentLang; languageSelector.addEventListener('change', e => setLanguage(e.target.value));
    document.getElementById('expenseDate').valueAsDate = new Date();
    document.getElementById('newSaleDate').valueAsDate = new Date();
    setLanguage(currentLang); 
    applyTheme(currentTheme); 
    refreshAll(); 
    showPage('dashboardPage');
});
</script>
</body>
</html>